generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String        @id @default(cuid())
  clerkId    String        @unique
  email      String        @unique
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  workflows  Workflow[]
  workflowRuns WorkflowRun[]
}

model Workflow {
  id          String        @id @default(cuid())
  name        String
  description String?
  nodes       Json
  edges       Json
  viewport    Json?
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  runs        WorkflowRun[]

  @@index([userId])
}

model WorkflowRun {
  id             String          @id @default(cuid())
  workflowId     String?
  workflow       Workflow?       @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  userId         String
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  status         String          // success, failed, partial, running
  runType        String          // full, partial, single
  nodeCount      Int             @default(0)
  startedAt      DateTime        @default(now())
  completedAt    DateTime?
  duration       Int?            // milliseconds
  nodeExecutions NodeExecution[]

  @@index([userId])
  @@index([workflowId])
}

model NodeExecution {
  id            String      @id @default(cuid())
  workflowRunId String
  workflowRun   WorkflowRun @relation(fields: [workflowRunId], references: [id], onDelete: Cascade)
  nodeId        String
  nodeType      String
  status        String      // success, failed, running
  inputs        Json
  outputs       Json?
  error         String?
  duration      Int?        // milliseconds
  executedAt    DateTime    @default(now())

  @@index([workflowRunId])
}